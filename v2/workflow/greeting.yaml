note: Greeting & Initial Customer Identificatoin
nodes:
  init:
    type: analyze
    client:
      prompt: |
        With chat history and client's message ( $message ), determine conversatoin intent.

        Output current conversation step as following json schema:
        ```json
        {
          "intent": string // greeting | contact | addresses
        }
        ```

        here:
        greeting: Greeting message like (Hi, or Hello)
        contact: Asking and answering or confirming contact information
        addresses: Asking and answering or confirming service address

        Important:
        If customer send first help message (e.g. Hi, my AC stopped working.), determien intent as "contact".

        Output only json code. Any plaintext or explanations are not allowed.
      return: intent_data
    go_to:
      data: intent_data
      cases:
        - name: intent
          value: greeting
          to: greeting
          step: greeting
        - name: intent
          value: contact
          to: greeting
          step: fetch_contact_information
        - name: intent
          value: addresses
          to: greeting
          step: go_to_addresses
      default:
        to: greeting
        step: init
  greeting:
    type: process
    client:
      prompt: |
        Base text:
        """
        Welcome to Acme! I'm Uno, your digital assistant. Before 
        """ + [Continue naturally based on customer's request and conversation context]

        Update this welcome message.
        Output: ONLY the updated assistant message (no explanations, no extra text, no code format).
    go_to:
      data:
      cases: []
      default:
        finished: true
        to: greeting
        step: fetch_contact_information
  fetch_contact_information:
    type: callback
    client:
      name: get_contact_information
      args: []
      return: contact_information
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: analyze_contact_information
  analyze_contact_information:
    type: analyze
    client:
      prompt: |
        Check the Current Customer Contact Information section for the existing customer information
        Current Customer Contact Information: $contact_information
        Customer's current message: $message

        Requried fields:
        - full_name: requried
        - phone_number: required
        - email_address: optional

        Determine Conversation intent as following schema:
        ```json
        {
          "intent": string // all | some | none | all_confirmed | update_contact
        }
        ``` 

        Here:
        - all: All contact informations exist. Need to confirm only
        - some: Some contact informations exist, but some is missing
        - none: All contact informations are not existing. Need to ask
        - all_confirmed: All contact information exist, and customer already confirmed in this message
        - update_contact: Customer answered about asking contact information in this message, and want to update it.

        Example conversaions:
        ### intent: all | some | none
        User: Hi
        Assistant: Welcome to Acme! I'm Uno, your digital assistant. What can I assist you?
        User: My AC is broken

        ### intent: all_confirmed
        User: My AC is broken
        Assistant: Before start, I wanna confirm your contact information. I've see your information is existing with this file: [full_name], [phone_number], and email [email address].
                   If all is correct, could you confirm please?
        User: Yes confirm

        ### intent: update_contact
        User: My AC is broken
        Assistant: Before start, I wanna confirm your contact information. I've see your information is existing with this file: [full_name], [phone_number], and email [email address].
                   If all is correct, could you confirm please?
        User: I want to update. My phone number is ...

        Output only json code. Any plaintext or explanations are not allowed.
      return: intent_data
    go_to:
      data: intent_data
      cases:
        - name: intent
          value: all
          to: greeting
          step: ask_confirm_contact_information
        - name: intent
          value: some
          to: greeting
          step: ask_more_contact_information
        - name: intent
          value: none
          to: greeting
          step: ask_contact_information
        - name: intent
          value: all_confirmed
          to: greeting
          step: update_contact_status
        - name: intent
          value: update_contact
          to: greeting
          step: analyze_update_contact_information
      default:
        to: greeting
        step: analyze_contact_information
  ask_confirm_contact_information:
    type: process
    client:
      prompt: |
        Base text:
        """
        Before go ahead, I have your information on file: [full name], [phone_number], and email [email address]. Is this all correct?
        """
        or 
        """
        About contact information, I have your information on file: [full name], [phone_number], and email [email address]. Is this all correct?
        """

        Current Contact Information: $contact_information

        Task:
        You should generate confirmation message. make more natively and friendly.

        Output: ONLY the updated assistant message (no explanations, no extra text, no code format).
    go_to:
      data:
      cases: []
      default:
        finished: true
        to: intent
        step: init
  ask_more_contact_information:
    type: process
    client:
      prompt: |
        Base text:
        """
        Before start, I see your contact information in this file: [full_name], but can't find phone number. The email address is optional but if you provide it, it will be more helpful.
        """
        or 
        """
        I've updated contact information but still some info is required like phone number. Could you share this info please?
        """

        According to chat history, update text more friendly and natively.
        Output: ONLY updated assistant message (no explanations, no extra text, no code format)
    go_to:
      data:
      cases: []
      default:
        finished: true
        to: intent
        step: init
  ask_contact_information:
    type: process
    client:
      prompt: |
        Base text:
        """
        Sorry, but I can't find your contact information. It's necessary to make a new appointment. Could you share your contact information please?
        """
        or 
        """
        About contact information, unfortunately, I can't find your contact information. It's necessary to make a new appointment. Could you share your contact information please?
        """
        or 
        """
        I've received your message and tried to update contact information, but we couldn't find any required information. Could you provide your contact information again please?
        """
        or
        """
        What do you want to update contact information? Pleae feel free to provide.
        """

        According to chat history, update text more friendly and natively.
        Output: ONLY updated assistant message (no explanations, no extra text, no code format)
    go_to:
      data:
      cases: []
      default:
        finished: true
        to: intent
        step: init
  analyze_update_contact_information:
    type: analyze
    client:
      prompt: |
        Analyze the customer message: $message
        And determine updatable contact information as following json schema:
        ```json
        {
          "full_name": string | null,
          "phone_number": string | null,
          "email_address": string | null,
          "updatable": boolean // it should be true when full_name is not null or phone_number is not null. But if they are null, it should be false
        }
        ```

        Output only json code. Any plaintext or explanations are not allowed.
      return: update_contact_information
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: update_contact_information
  update_contact_information:
    type: callback
    client:
      name: update_contact_information
      args: 
        - update_contact_information
      return: update_contact_information_result
    go_to:
      data: update_contact_information_result
      cases: 
        - name: status
          value: failed
          to: greeting
          step: ask_contact_information
        - name: status
          value: full
          to: greeting
          step: update_contact_status
        - name: status
          value: some_missed
          to: greeting
          step: ask_more_contact_information
        - name: status
          value: all_missed
          to: greeting
          step: ask_contact_information
      default:
        to: greeting
        step: update_contact_status
  update_contact_status:
    type: callback
    client:
      name: update_customer_status
      args: []
      return:
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: finish_contact_information
  finish_contact_information:
    type: process
    client:
      prompt: |
        Base text:
        """
        Thank you for confirming your contact information.
        """
        or
        """
        We've updated your contact information successfully.
        """

        According to chat history, update text more friendly and natively.
        Output: ONLY updated assistant message (no explanations, no extra text, no code format).
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: fetch_service_addresses
  go_to_addresses:
    type: callback
    client:
      name: get_customer_status
      args: []
      return: customer_status
    go_to:
      data: customer_status
      cases:
        - name: greeting
          value: true
          to: greeting
          step: analyze_service_response
        - name: greeting
          value: false
          to: greeting
          step: reback_to_contact
      default:
        to: greeting
        step: analyze_service_response
  reback_to_contact:
    type: process
    client:
      prompt: |
        Base text:
        """
        Before discuss about service addresses, we need to ensure the contact information.
        """
        or 
        """
        We need to confirm contact information first.
        """
        Update this text more friendly and natively according to chat history

        Output ONLY updated text. (no explanations, no extra text, no node format)
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: fetch_contact_information
  fetch_service_addresses:
    type: callback
    client:
      name: get_service_addresses
      args: []
      return: service_addresses
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: analyze_service_addresses
  analyze_service_addresses:
    type: analyze
    client:
      prompt: |
        Current addresses: $service_addresses
        Analyze addresses and output json data as following schema:
        ```json
        {
          "intent": string // exist | none
        }
        ```
        Here
        exist: The current addresses have got items
        none: The current addresses don't have got items or none

        Output only json code. Anly plaintext or explanations are not allowed.
      return: intent_data
    go_to:
      data: intent_data
      cases:
        - name: intent
          value: exist
          to: greeting
          step: ask_confirm_service_addresses
        - name: intent
          value: none
          to: greeting
          step: ask_service_addresses
      default:
        to: greeting
        step: ask_confirm_service_addresses
  ask_confirm_service_addresses:
    type: process
    client:
      prompt: |
        Base text:
        """
        Next, we need to confirm service receiving address. Would you confirm exact address among your service addresses: $service_addresses?
        """
        or 
        """
        We need to confirm service receiving address. Could you confirm exact address in your service addresses list: $service_addresses?
        """

        Important: If address is already exist list, mention addresses.
        Here exist list is: $
        If exist, need to select, and if no list, need to get address.

        This is to ask confirm receiving address in existing service address list.
        Please update above base text according to chat history more friendly, natively, and reasonably.

        Output ONLY updated assistant message. (no explanations, no extra text, no code format)
    go_to:
      data:
      cases: []
      default:
        finished: true
        to: intent
        step: init
  ask_service_addresses:
    type: process
    client:
      prompt: |
        Base text:
        """
        Next, could you please provide the address where you need the [service]? This will help me make sure we send help to the right place.Next, We 
        """
        or
        """
        Could you provide address where you need to receive service?
        """
        or 
        """
        Sorry, but your service address is not supported. Could you provide another address please?
        """

        Important
        If customer answered address, but still you should ask address, it's because the custoerm mentioned address is not validated or not supported.

        This is to ask service receiving address.
        Please update above base text according to chat history more friendly, more natively and reasonably.

        Output ONLY updated assistant message. (no explanations, no extra text, no code format)
    go_to:
      data:
      cases: []
      default:
        finished: true
        to: intent
        step: init
  analyze_service_response:
    type: analyze
    client:
      prompt: |
        Current service addresses: $service_addresses
        Customer message: $message
        Analyze customer message and output following json schema data:
        ```json
        {
          "service_address": string,
          "not_mentioned_address": boolean,
          "canceled": boolean
        }
        ```

        Here, analyze message and determine exact service receiving address reference current service addresses.
        But it can be different address to current service addresses.
        And not_mentioned_address:
        It should be true if address is null or empty string
        And about canceled:
        If customer responded address is not supported, customer can cancel service, and in this case, canceled should be true

        Output only json data code. Any explanations or plaintext are not allowed.
      return: update_service_address
    go_to:
      data: update_service_address
      cases: 
        - name: not_mentioned_address
          value: true
          to: greeting
          step: ask_service_addresses
        - name: canceled
          value: true
          to: extra
          step: handle_cancel
      default:
        to: greeting
        step: validate_service_addresses
  validate_service_addresses:
    type: callback
    client:
      name: validate_service_address
      args:
        - update_service_address
      return: validate_result
    go_to:
      data: validate_result
      cases: 
        - name: validated
          value: true
          to: greeting
          step: finish_service_address
        - name: validated
          value: false
          to: greeting
          step: ask_service_addresses
      default:
        to: greeting
        step: finish_service_address
  finish_service_address:
    type: process
    client:
      prompt: |
        Base text:
        """
        Thank you for providing address. We validated your address, and saved.
        """
        or
        """
        Thanks for sharing your address!
        """

        Update assistant message more friendly and natively according to chat history.
        Don't ask any question or confirmation. It's for finishing and should move next step.

        Output ONLY updated assistant message. (no explanations, no extra text, no code format)
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: finish_agent
  finish_agent:
    type: callback
    client:
      name: finish_greeting_agent
      args: []
      return:
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: go_to_other_agent
  go_to_other_agent:
    type: callback
    client:
      name: get_customer_status
      args: []
      return: customer_status
    go_to:
      data: customer_status
      cases:
        - name: service_information
          value: false
          to: service
          step: collect_services
        - name: property
          value: false
          to: property
          step: init
        - name: dispatch
          value: false
          to: dispatch
          step: collect_available_times
      default:
        to: extra
        step: handle_success