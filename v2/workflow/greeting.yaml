note: "Greeting & Initial Customer Identificatoin"
nodes:
  init:
    type: analyze
    client:
      prompt: |
        With chat history and client's message ( $message ), determine conversatoin intent.

        Output current conversation step as following json schema:
        ```json
        {
          "intent": string // greeting | contact | addresses
        }
        ```

        here:
        greeting: Greeting (ONLY if this is your FIRST message in the conversation)
        contact: Confirm Contact Customer Information
        addresses: Confirm Service Addresses

        Important:
        If customer send first help message (e.g. Hi, my AC stopped working.), determien intent as "contact".

        Output only json code. Any plaintext or explanations are not allowed.
      return: intent_data
    go_to:
      data: intent_data
      cases:
        - name: intent
          value: greeting
          to: greeting
          step: greeting
        - name: intent
          value: contact
          to: greeting
          step: fetch_contact_information
        - name: intent
          value: addresses
          to: greeting
          step: go_to_addresses
      default:
        to: greeting
        step: init
  greeting:
    type: process
    client:
      prompt: |
        Base text:
        """
        Welcome to Acme! I'm Uno, your digital assistant. Before 
        """ + [Continue naturally based on customer's request and conversation context]

        Update this welcome message.
        Output: ONLY the updated assistant message (no explanations, no extra text, no code format).
    go_to:
      data:
      cases: []
      default:
        finished: true
        to: intent
        step: init
  fetch_contact_information:
    type: callback
    client:
      name: get_contact_information
      args: []
      return: contact_information
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: analyze_contact_information
  analyze_contact_information:
    type: analyze
    client:
      prompt: |
        Check the Current Customer Contact Information section for the existing customer information
        Current Customer Contact Information: $contact_information
        Customer's current message: $message

        Requried fields:
        - full_name: requried
        - phone_number: required
        - email_address: optional

        Determine Conversation intent as following schema:
        ```json
        {
          "intent": string // all | some | none | all_confirmed | update_contact
        }
        ``` 

        Here:
        - all: All contact informations exist. Need to confirm only
        - some: Some contact informations exist, but some is missing
        - none: All contact informations are not existing. Need to ask
        - all_confirmed: All contact information exist, and customer already confirmed in this message
        - update_contact: Customer answered about asking contact information in this message, and want to update it.

        Example conversaions:
        ### intent: all | some | none
        User: Hi
        Assistant: Welcome to Acme! I'm Uno, your digital assistant. What can I assist you?
        User: My AC is broken

        ### intent: all_confirmed
        User: My AC is broken
        Assistant: Before start, I wanna confirm your contact information. I've see your information is existing with this file: [full_name], phone ending in [last 4 digits], and email [email address].
                   If all is correct, could you confirm please?
        User: Yes confirm

        ### intent: update_contact
        User: My AC is broken
        Assistant: Before start, I wanna confirm your contact information. I've see your information is existing with this file: [full_name], phone ending in [last 4 digits], and email [email address].
                   If all is correct, could you confirm please?
        User: I want to update. My phone number is ...

        Output only json code. Any plaintext or explanations are not allowed.
      return: intent_data
    go_to:
      data: intent_data
      cases:
        - name: intent
          value: all
          to: greeting
          step: ask_confirm_contact_information
        - name: intent
          value: some
          to: greeting
          step: ask_more_contact_information
        - name: intent
          value: none
          to: greeting
          step: ask_contact_information
        - name: intent
          value: all_confirmed
          to: greeting
          step: update_contact_status
        - name: intent
          value: update_contact
          to: greeting
          step: analyze_update_contact_information
      default:
        to: greeting
        step: analyze_contact_information
  ask_confirm_contact_information:
    type: process
    client:
      prompt: |
        Base text:
        """
        Before go ahead, I have your information on file: [full name], phone ending in [last 4 digits], and email [email address]. Is this all correct?
        """
        or 
        """
        About contact information, I have your information on file: [full name], phone ending in [last 4 digits], and email [email address]. Is this all correct?
        """

        Current Contact Information: $contact_information

        Task:
        You should generate confirmation message. make more natively and friendly.

        Output: ONLY the updated assistant message (no explanations, no extra text, no code format).
    go_to:
      data:
      cases: []
      default:
        finished: true
        to: intent
        step: init
  ask_more_contact_information:
    type: process
    client:
      prompt: |
        Base text:
        """
        Before start, I see your contact information in this file: [full_name], but can't find phone number. The email address is optional but if you provide it, it will be more helpful.
        """
        or 
        """
        I've updated contact information but still some info is required like phone number. Could you share this info please?
        """

        According to chat history, update text more friendly and natively.
        Output: ONLY updated assistant message (no explanations, no extra text, no code format)
    go_to:
      data:
      cases: []
      default:
        finished: true
        to: intent
        step: init
  ask_contact_information:
    type: process
    client:
      prompt: |
        Base text:
        """
        Sorry, but I can't find your contact information. It's necessary to make a new appointment. Could you share your contact information please?
        """
        or 
        """
        About contact information, unfortunately, I can't find your contact information. It's necessary to make a new appointment. Could you share your contact information please?
        """
        or 
        """
        I've received your message and tried to update contact information, but we couldn't find any required information. Could you provide your contact information again please?
        """
        or
        """
        What do you want to update contact information? Pleae feel free to provide.
        """

        According to chat history, update text more friendly and natively.
        Output: ONLY updated assistant message (no explanations, no extra text, no code format)
    go_to:
      data:
      cases: []
      default:
        finished: true
        to: intent
        step: init
  analyze_update_contact_information:
    type: analyze
    client:
      prompt: |
        Analyze the customer message: $message
        And determine updatable contact information as following json schema:
        ```json
        {
          "full_name": string | null,
          "phone_number": string | null,
          "email_address": string | null,
          "updatable": boolean // it should be true when full_name is not null or phone_number is not null. But if they are null, it should be false
        }
        ```

        Output only json code. Any plaintext or explanations are not allowed.
      return: update_contact_information
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: update_contact_information
  update_contact_information:
    type: callback
    client:
      name: update_contact_information
      args: 
        - update_contact_information
      return: update_contact_information_result
    go_to:
      data: update_contact_information_result
      cases: 
        - name: status
          value: failed
          to: greeting
          step: ask_contact_information
        - name: status
          value: full
          to: greeting
          step: update_contact_status
        - name: status
          value: some_missed
          to: greeting
          step: ask_more_contact_information
        - name: status
          value: all_missed
          to: greeting
          step: ask_contact_information
      default:
        to: greeting
        step: update_contact_status
  update_contact_status:
    type: callback
    client:
      name: update_customer_status
      args: []
      return:
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: finish_contact_information
  finish_contact_information:
    type: process
    client:
      prompt: |
        Base text:
        """
        Thank you for confirming your contact information.
        """
        or
        """
        We've updated your contact information successfully.
        """

        According to chat history, update text more friendly and natively.
        Output: ONLY updated assistant message (no explanations, no extra text, no code format).
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: fetch_service_addresses
  go_to_addresses:
    type: callback
    client:
      name: get_customer_status
      args: []
      return: customer_status
    go_to:
      data: customer_status
      cases:
        - name: greeting_contact
          value: true
          to: greeting
          step: analyze_service_response
        - name: greeting_contact
          value: false
          to: greeting
          step: reback_to_contact
      default:
        to: greeting
        step: analyze_service_response
  reback_to_contact:
    type: process
    client:
      prompt: |
        Base text:
        """
        Before discuss about service addresses, we need to ensure the contact information.
        """
        Update this text more friendly and natively

        Output ONLY updated text. (no explanations, no extra text, no node format)
    go_to:
      default:
        to: greeting
        step: fetch_contact_information
  fetch_service_addresses:
    type: callback
    client:
      name: get_service_addresses
      args: []
      return: service_addresses
    go_to:
      data:
      cases: []
      default:
        to: greeting
        step: analyze_service_addresses
  analyze_service_addresses:
    type: analyze
    client:
      prompt: |
        Current addresses: $service_addresses
        Analyze addresses and output json data as following schema:
        ```json
        {
          "intent": string // exist | none
        }
        ```
        Here
        exist: Service addresses exist in this list
        none: Service addresses not exist in this list

        Output only json code. Anly plaintext or explanations are not allowed.
      return: intent_data
    go_to:
      data: intent_data
      cases:
        - name: intent
          value: exist
          to: greeting
          step: confirm_service_addresses
        - name: intent
          value: none
          to: greeting
          step: ask_service_addresses
      default:
        to: greeting
        step: confirm_service_addresses
  confirm_service_addresses:
    type: process
    client:
      prompt: |

  analyze_service_response:
    type: analyze
    client:
      prompt: |
        Current service addresses: $service_addresses
        Customer message: $message
        Analyze addresses and message, and output json data as following schema:
        ```json
        {
          "intent": selected | new_address | not_given
        }
        ```
        Here,
        selected: Customer mentioned an service address and it is in service addresses.
        new_address: Customer mentioned service address is not in service addresses, but Customer gave exact service address.
        not_given: Customer didn't give any address and didn't selected any address from list.

        Output only json code. Anly plaintext or explanations are not allowed.
      return: intent_data
    go_to:
      data: intent_data
      cases:
        - name: intent
          value: selected
          to: greeting
          step: validate_service_addresses
        - name: intent
          value: new_address
          to: greeting
          step: update_service_addresses
        - name: intent
          value: not_given
          to: greeting
          step: update_service_addresses
      default:
        to: greeting
        step: validate_service_addresses